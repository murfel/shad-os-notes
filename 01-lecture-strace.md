# Лекция 1
После слайдов, последние 15 минут лекции.

## strace

### Резюме
- `strace -f echo hi` простейший пример использования strace
- `-f` системные вызовы из всех потоков
- `-yy` расшифровать файловые дескрипторы
- `-p pid` подключиться к уже запущенному процессу с указанным pid (нужно sudo)
- `ps aux | grep sleep` найти pid процесса по ключевому слову sleep

### Длинная версия

Команда в терминале strace позволяет посмотреть, какие системные вызовы делает программа.
Например, для отладки своей или чужой программы. Например:
- висит на сетевом вызове
- делает слишком много записей на диск
- открывает несуществующий файл

Флаг `-f` показывает системные вызовы из всех потоков, не только main. Советуют использовать всегда.

```
$ echo hi
$ strace -f echo hi
execve("/usr/bin/echo", ["echo", "hi"], 0x7ffddf91e490 /* 46 vars */) = 0
...
write(1, "hi\n", 3hi
)                     = 3
...
```
([Полный вывод](https://gist.github.com/murfel/1c4e66e464d0bd3ae8782fbdc4bca8bc#file-strace_echo_hi-L41))

Интересные вызовы:

`execve` - системный вызов от Баша, который вызывает команду echo с аргументом hi. Обсудим на семинаре.

`write`

[man 2 write](https://linux.die.net/man/2/write)

Тут перемешался вызов двух команд: `write(1, "hi\n", 3)` - это вызов write, а второй `hi` пришел от вызова echo hi.

Первый аргумент write - файловый дескриптор 1, это stdout.
С каждым процессом ассоциировано три главных файловых дескриптора: ввода stdin, и два вывода stdout (основной вывод программы), stderr (вывод для ошибок).
Эти дескрипторы могут указывать на разные файлы. В этом случае stdout указывает на виртуальный файл, который соответствует терминалу.

Второй и третий аргумент указывают на строчку и количество байт. Здесь явно написана строка `"hi\n"`, но на самом деле в исходном вызове был адрес строки, а strace подставил значение строки по этому адресу для читаемости.

write вернул значение 3 (`= 3`), то есть за один вызов записалась вся строчка `hi`.

### Перенаправление потоков и файловые дескрипторы

Можно перенаправить поток вывода (stdout) команды echo из терминала в файл `a.txt`:
```
$ strace -f echo hi >a.txt
...
write(1, "hi\n", 3)                     = 3
...
```

Тогда выводы strace и самой трассируемой команды не будут мешаться. Заметьте, что файловый дескриптор остался 1, так как это все ещё stdout, мы лишь переопределили куда смотрит stdout. Если мы трассируем чужую программу, мы можем не знать с чем именно ассоциирован каждый файловый дескриптор.

Флаг `-yy` расшифровывает файловые дескрипторы.
```
$ strace -f echo hi >a.txt
write(1</home/natasha/a.txt>, "hi\n", 3) = 3

$ strace -f echo hi
write(1</dev/pts/2<char 136:2>>, "hi\n", 3hi
) = 3
```

`/dev/pts/2` - это виртуальный файл, ассоциированный с выводом в терминал.

### Ошибки

```
$ cat b.txt
cat: b.txt: No such file or directory
$ strace -f cat b.txt
...
openat(AT_FDCWD, "b.txt", O_RDONLY)     = -1 ENOENT (No such file or directory)
...
```
([Полный вывод](https://gist.github.com/murfel/0108ecc882909a8d1791b3789a833723#file-cat-no-such-file-L41))

[man 2 openat](https://linux.die.net/man/2/openat)

Системный вызов `openat` пытался открыть файл b.txt с флагом O_RDONLY, это флаг открытия файла только на чтение. Такого файла нет, поэтому openat вернул -1. В переменную ERRNO записался номер 2, соответствующий ошибке ENOENT (No such file or directory), и в этом случае тоже strace по-джентельменски подставил название и описание ошибки, а не только число, хранящееся в ERRNO.

Список разных ошибок:
https://man7.org/linux/man-pages/man3/errno.3.html

### Подключение к работающему процессу

#### Зависающий процесс
Попытаемся отдебагать зависшую программу.
```
$ sleep 10000
```

Найдём ее pid в другом окне терминала.
```
$ ps aux | grep sleep
natasha  1396983  0.0  0.0   8288  2048 pts/1    S+   10:02   0:00 sleep 10000
natasha  1396999  0.0  0.0   9144  2304 pts/2    S+   10:02   0:00 grep --color=auto sleep
```

Первый процесс с пидом 1396983 наш.

Флаг `-p` позволяет подключиться к процессу.

```
$ sudo strace -f -p 1396983
strace: Process 1396983 attached
restart_syscall(<.. resuming interrupted read ...>)
# программа не завершается
# CTRL+C
^Cstrace: Process 1396983 detached
 <detached ...>
```

#### Печатающий процесс
Это скучный пример, потому что в sleep ничего не происходит. Давайте печатать hi:
```
nano a.py
while True:
    print('hi')
# Нажмите CTRL+X и Y, чтобы выйти из nano

$ python a.py
```

В другом терминале:
```
$ ps aux | grep a.py
# скопируем pid
$ sudo strace -f -p pid
...
write(1, "hi\n", 3)                     = 3
write(1, "hi\n", 3)                     = 3
write(1, "hi\n", 3)                     = 3
...
```

### Больше про strace
[man strace](https://man7.org/linux/man-pages/man1/strace.1.html)

Смотрите документацию, там много всего полезного. Например,
- фильтры на сисколы: можно смотреть только на write
- сэмплинг: выводить только каждый k-й сискол
- агрегация статистики по сисколам - запустить программу на 10 секунд под strace, посмотреть где проводим больше всего времени.

Недавняя новая функциональность - инъекции ошибок в код. Хотим посмотреть, что будет, если диск часто будет отказываться записывать.

## Команда man
Чтение документации без интернета. 

Просто `man x` - документация по команде терминала x, `man 2 x` - по системному вызову x.

```
man 2 read
```

Описываются все аргументы, возвращаемые значения в разных ситуациях и даже список всех возможных ошибок.

Можно посмотреть ман на ман, там мы узнаем, что, например, 2 - это секция системных вызовов, а 3 - библиотек.
```
man man
```
