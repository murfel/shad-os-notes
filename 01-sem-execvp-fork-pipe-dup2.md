# Семинар 1
## Установка Rust
На маке с ARM точно не получится, на x64-86 может быть, но никто не пробовал.

VSCode + планигины codeLLDB и rust-analyzer

но я буду юзать rust rover :)

## Домашка
Проэмулировать баш, чтобы можно было выполнять такие команды:
```
$ echo hi
$ echo hi >a.txt <a.in
$ cat a.txt | wc -l | ... | ... | ...
```

## execvp
Исполняет команду с переданными аргументами. Первый аргумент обычно совпадает с названием программы. Но может отличаться, есть редкие (разумные) кейсы, когда программы могут себя по-разному вести в зависимости от их названия.

Например: пакет стандартных консольных утилит [BusyBox](https://en.wikipedia.org/wiki/BusyBox) распространяющийся как один бинарник. Бинарник будет вести себя в соответствии с тем, как он будет называться. 

```
execvp(cmd, [args])
execvp(echo, [echo, hi]) -> exit(0)
```

## fork
```
    |
    |
    v
   fork
|        |
v        v
ret 42;  ret 0;

if (fork() > 0) {
    // копия
} else {
    // оригинал
}

waitpid(42) -> ret - ждём завершение дочернего процесса, узнаем его код возврата через ret.
```

fork
- Оптимизация copy-on-write для памяти.
- Нужно думать про разделяемые ресурсы.
- У ребёнка будет _копия_ файловых дескрипторов. Если родитель прочитал из файла, позиция в файле у ребенка не изменится.
- При форке многопоточного процесса в копии будет только один тред.
  - Если была захвачена блокировка во втором потоке, то в копии никто никогда не сможет ее отпустить.
- Форк с разделяемыми ресурсами. Можно сделать fork-aware spinlock, обсудим в лекции про блокировки.

## Перенаправление ввода/ввывода
Хотим подменить ввод-ввывод на наши файлы.

```
open('a.txt', flags, mode) -> fd
dup2(x, y)  // close(y), y = clone(x)
close(fd)
```

`open` - открытие файла. Флаги: на чтение, на запись, создать файл если его нет. mode - права на файл, в случае его создания.

Клон дескриптора - чтение по одному не двигает другой.

Номера файловых дескрипторов для ввода-вывода:
```
stdin 0
stdout 1
stderr 2
```

## Pipe
### Склеить вывод одной команды в ввод другой.

`pipe() -> (x, y)` - создаёт трубу, где на входе файловый дескриптор x, на выходе - y: `x -> ()======() -> y`. Все, что пишется в x, будет читать y.

### Запускать много процессов из одного процесса.
Построить дерево процессов из форков.
```
   /\
  /  \
c1   /\
    /  \
   c2  /\
  ... /  \
     cn
```
Создаём пайп для c1-c2, форкаемся в c2 и т.д.

## Rust
https://gist.github.com/murfel/5ca99302a54510d2783e782cf1fcb522
